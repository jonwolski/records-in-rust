<html>
  <head>
    <title>Zero-cost functional records in Rust</title>
<link rel="stylesheet" href="./basic.css" />
  </head>
  <body>

<h1 id="zero-cost-functional-records-in-rust">Zero-cost Functional Records in Rust</h1>
<p>A friend and colleague piqued my interest with a comment about using an immutable functional style in Haskell or Rust and the invisible impact it has on performance compared ostensibly to imperative C or C++.</p>
<p>I’ve played with Haskell only enough to learn one for great good—not enough to know about any performance gotchas. However, I <em>do</em> have some Rust in production, so I’ll focus on that.</p>
<p>Let’s see what Rust can do.</p>
<h2 id="tldr-rust-enables-zero-cost-functional-style11">tl;dr: Rust enables zero-cost functional style<sup><a href="#1">1</a></sup></h2>
<p>First lets create a <code>struct</code>. I’ll call my new datatype <code>Record</code>. (This is just my name for it; “Record” is not a Rust keyword.)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Copy</span><span class="op">,</span> <span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Record <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    a<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    b<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    c<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>To make it interesting, I’ve given the <code>Record</code> type some fields arbitrarily:</p>
<ul>
<li><code>a</code> - an unsigned 32-bit integer (<code>u32</code>)</li>
<li><code>b</code> - an unsigned 32-bit integer (<code>u32</code>)</li>
<li><code>c</code> - a Boolean (<code>bool</code>)</li>
</ul>
<p>Now let’s create some functions to mutate the struct.</p>
<h2 id="mutating-the-fields-in-place">Mutating the fields in-place</h2>
<p>Ostensibly, mutating the record in-place will be more ‘performant’ than creating a copy of the struct each time we want to change a field.</p>
<h3 id="toggle-the-records-boolean-flag">Toggle the Record’s Boolean flag</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> toggle_record(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    record<span class="op">.</span>c <span class="op">=</span> <span class="op">!</span>record<span class="op">.</span>c<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For those unfamiliar with Rust syntax, this function takes a <em>mutable</em> reference to a Record (<code>&amp;mut Record</code>) and binds it to a parameter named <code>record</code>. The function updates the record’s <code>c</code> field. De-referencing is implicit.</p>
<p>It returns <code>Void</code>.</p>
<p>Let’s have a couple more functions to update the other fields.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> increment_record(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    record<span class="op">.</span>a <span class="op">=</span> record<span class="op">.</span>a <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// this will treat `a` as an &quot;accumulator&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// Mostly I wrote this function just to give the compiler some more</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// difficulty by both reading from and writing to the same variable.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> accumulate_record(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    record<span class="op">.</span>a <span class="op">=</span> record<span class="op">.</span>a <span class="op">+</span> record<span class="op">.</span>b<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    record<span class="op">.</span>b <span class="op">=</span> record<span class="op">.</span>a<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="functional-immutable-style">Functional / Immutable Style</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_toggled_record(record<span class="op">:</span> Record) <span class="op">-&gt;</span> Record <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    Record <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        c<span class="op">:</span> <span class="op">!</span>record<span class="op">.</span>c<span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">..</span>record</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_incremented_record(record<span class="op">:</span> Record) <span class="op">-&gt;</span> Record <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    Record <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        a<span class="op">:</span> record<span class="op">.</span>a <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">..</span>record</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> get_accumulated_record(record<span class="op">:</span> Record) <span class="op">-&gt;</span> Record <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    Record <span class="op">{</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        a<span class="op">:</span> record<span class="op">.</span>a <span class="op">+</span> record<span class="op">.</span>b<span class="op">,</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        b<span class="op">:</span> record<span class="op">.</span>a<span class="op">,</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">..</span>record</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">/// mutate in-place, imperative style</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_with_refs(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    toggle_record(record)<span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    increment_record(record)<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    accumulate_record(record)<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">/// immutable record, functional style</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_with_ptrs(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> get_toggled_record(<span class="op">*</span>record)<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> get_incremented_record(<span class="op">*</span>record)<span class="op">;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> get_accumulated_record(<span class="op">*</span>record)<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">/// minimize use of pointers by nesting function calls</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_with_minimal_vars(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> get_accumulated_record(get_incremented_record(get_toggled_record(<span class="op">*</span>record)))<span class="op">;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co">/// minimize use of pointers with shadowed tmp vars</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_with_shadowed_vars(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tmp <span class="op">=</span> <span class="op">*</span>record<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tmp <span class="op">=</span> get_toggled_record(tmp)<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tmp <span class="op">=</span> get_incremented_record(tmp)<span class="op">;</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tmp <span class="op">=</span> get_accumulated_record(tmp)<span class="op">;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">/// minimize use of pointers with a single, mutable tmp var</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_with_mut_tmp_var(record<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> Record) <span class="op">{</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tmp <span class="op">=</span> <span class="op">*</span>record<span class="op">;</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> get_toggled_record(tmp)<span class="op">;</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> get_incremented_record(tmp)<span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    tmp <span class="op">=</span> get_accumulated_record(tmp)<span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>record <span class="op">=</span> tmp<span class="op">;</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_no_refs(record<span class="op">:</span> Record) <span class="op">-&gt;</span> Record <span class="op">{</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> record <span class="op">=</span> get_toggled_record(record)<span class="op">;</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    record <span class="op">=</span> get_incremented_record(record)<span class="op">;</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    record <span class="op">=</span> get_accumulated_record(record)<span class="op">;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    record</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>inline<span class="at">(</span>never<span class="at">)]</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> update_record_mut(record<span class="op">:</span> Record) <span class="op">-&gt;</span> Record <span class="op">{</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> record <span class="op">=</span> record<span class="op">;</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    toggle_record(<span class="op">&amp;</span><span class="kw">mut</span> record)<span class="op">;</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    increment_record(<span class="op">&amp;</span><span class="kw">mut</span> record)<span class="op">;</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    accumulate_record(<span class="op">&amp;</span><span class="kw">mut</span> record)<span class="op">;</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    record</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div id="1">
<p>Technically, it may be <em>LLVM</em> that enables this, but I think the Rust compiler team would have to do at least <em>some</em> work to take advantage of it.</p>
<p>Also, when I say “zero cost,” I mean “run-time perfomrance cost.” That is, writing in a functional style will not result in more memory usage or CPU cycles than writing in a more imperative, mutable style.</p>
</div>
  </body>
</html>
